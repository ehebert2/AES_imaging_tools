# 血管骨架非线性变换 - 中间点功能使用说明

## 概述

这个增强版本的脚本允许您通过指定中间点（waypoints）来控制血管路径的选择，解决了原始脚本只能找到最短路径的限制。

## 文件说明

1. **`nonlinear_transform_of_3d_graph_segment_with_waypoint.m`** - 支持单个中间点
2. **`nonlinear_transform_of_3d_graph_segment_multi_waypoints.m`** - 支持多个中间点

## 功能特点

### 原始脚本的限制
- 只能找到从起点a到终点b的最短路径
- 对于环形血管，总是选择最短的弧
- 无法控制路径的具体走向

### 新功能
- **单个中间点**：指定点c，路径变为 a → c → b
- **多个中间点**：指定点c1, c2, c3...，路径变为 a → c1 → c2 → c3 → ... → b
- **路径可视化**：不同路径段用不同颜色显示
- **详细路径信息**：显示每段路径的长度和总长度

## 使用方法

### 1. 单个中间点版本

```matlab
% 设置起点和终点
a = [88 265 29];  % 起点坐标 [x, y, z]
b = [69 199 46];  % 终点坐标 [x, y, z]

% 设置中间点（可选）
c = [95 220 35];  % 中间点坐标 [x, y, z]
% 或者不使用中间点
c = [];  % 空数组，使用最短路径
```

### 2. 多个中间点版本

```matlab
% 设置起点和终点
a = [88 265 29];  % 起点坐标 [x, y, z]
b = [69 199 46];  % 终点坐标 [x, y, z]

% 设置多个中间点（可选）
c = [95 220 35;    % 第一个中间点
     100 200 40;   % 第二个中间点
     85 180 45];   % 第三个中间点

% 或者不使用中间点
c = [];  % 空数组，使用最短路径
```

## 应用场景

### 1. 环形血管分析
```
原始问题：环形血管总是选择最短弧
解决方案：指定中间点，强制路径走另一条弧
```

### 2. 复杂血管网络
```
原始问题：自动选择的最短路径可能不是想要的
解决方案：通过中间点精确控制路径走向
```

### 3. 分段分析
```
应用：将长血管分成多个段进行分析
方法：设置多个中间点，分别分析每段的功能
```

## 输出结果

### 1. 可视化图形
- **图1**：3D血管网络图，显示选择的路径
- **图2**：路径的3D可视化，包括重采样点

### 2. 路径信息
```
路径段 1 (a -> c1): 长度 = 25.34
路径段 2 (c1 -> c2): 长度 = 18.67
路径段 3 (c2 -> b): 长度 = 22.15

总路径信息:
- 总路径长度: 66.16
- 路径段数: 3
```

### 3. 输出文件
- **原始版本**：`*_transformed.tif`
- **单中间点**：`*_transformed_with_waypoint.tif`
- **多中间点**：`*_transformed_with_multi_waypoints.tif`

## 注意事项

### 1. 坐标格式
- 坐标格式为 `[x, y, z]`
- 坐标必须在骨架中存在
- 如果坐标不存在，程序会报错

### 2. 路径连通性
- 所有指定的点之间必须存在连通路径
- 如果无法找到路径，程序会报错
- 建议先用原始脚本测试坐标的有效性

### 3. 内存使用
- 多中间点版本会占用更多内存
- 对于大型骨架，建议先测试小范围

## 示例代码

### 示例1：环形血管的另一条路径
```matlab
% 假设有一个环形血管，想要走另一条弧
a = [100 100 10];  % 起点
b = [100 100 10];  % 终点（同一点，环形）
c = [150 100 10];  % 中间点，强制走另一条弧
```

### 示例2：复杂血管网络的分段分析
```matlab
% 将长血管分成3段进行分析
a = [50 50 10];    % 起点
c = [100 100 15;   % 第一段终点/第二段起点
     150 80 20];   % 第二段终点/第三段起点
b = [200 120 25];  % 终点
```

### 示例3：避开特定区域
```matlab
% 通过中间点避开血管的某个区域
a = [50 50 10];    % 起点
c = [80 80 15];    % 中间点，避开中心区域
b = [120 120 20];  % 终点
```

## 故障排除

### 1. "中间点在骨架中未找到"错误
- 检查坐标是否正确
- 确认坐标在骨架数据范围内
- 使用原始脚本先验证坐标

### 2. "无法找到路径"错误
- 检查点之间是否连通
- 确认骨架数据质量
- 尝试调整坐标位置

### 3. 内存不足
- 减少中间点数量
- 使用更小的骨架数据
- 关闭其他MATLAB程序

## 技术细节

### 算法流程
1. 加载骨架数据和kymograph
2. 构建图结构
3. 计算各段最短路径
4. 拼接路径段
5. 进行非线性变换
6. 生成变换后的kymograph

### 路径拼接
- 去除重复的中间点
- 保持路径的连续性
- 计算累积路径长度

### 非线性变换
- 基于路径长度的分段线性插值
- 3D到2D的几何投影
- 时间-空间映射 